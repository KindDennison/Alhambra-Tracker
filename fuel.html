<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fuel Tracker – Seat Alhambra</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f9f9f9; }
    h1, h2 { color: #333; }
    form label { display: block; margin: 0.5rem 0; }
    input, button { padding: 0.5rem; margin-top: 0.2rem; width: 100%; max-width: 300px; }
    button { background: #0078D4; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #005bb5; }
    .card-grid { display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0; }
    .card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 5px #ccc; flex: 1; min-width: 150px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    canvas { max-width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Fuel Tracker – Seat Alhambra</h1>

  <section>
    <h2>Add Fuel Entry</h2>
    <form id="fuelForm">
      <label>Date: <input type="date" name="date" required /></label>
      <label>Cost (£): <input type="number" name="cost" step="0.01" required /></label>
      <label>Liters: <input type="number" name="liters" step="0.01" required /></label>
      <label>Miles Since Last Fill: <input type="number" name="miles" required /></label>
      <label>Notes: <input type="text" name="notes" /></label>
      <button type="submit">Add Entry</button>
    </form>
  </section>

  <section>
    <h2>Summary</h2>
    <div class="card-grid">
      <div class="card" id="avgMPG">Avg MPG: --</div>
      <div class="card" id="avgCostPerMile">Avg £/Mile: --</div>
      <div class="card" id="avgCostPerLiter">Avg £/Liter: --</div>
      <div class="card" id="totalMiles">Total Miles: --</div>
      <div class="card" id="totalSpend">Total Spend: --</div>
      <div class="card" id="totalLiters">Total Liters: --</div>
    </div>
  </section>

  <section>
    <h2>Charts</h2>
    <canvas id="mpgChart"></canvas>
    <canvas id="costChart"></canvas>
  </section>

  <section>
    <h2>Fuel Log</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Cost (£)</th>
          <th>Liters</th>
          <th>Miles</th>
          <th>MPG</th>
          <th>£/Mile</th>
          <th>£/L</th>
          <th>Notes</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDJXVZE2VZXPH9jJvzgz9ozBvvbiJfmLbw",
      authDomain: "teamdennisontracker.firebaseapp.com",
      projectId: "teamdennisontracker",
      storageBucket: "teamdennisontracker.firebasestorage.app",
      messagingSenderId: "915336870349",
      appId: "1:915336870349:web:c070e9b3fc0b688fe62c84"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const form = document.getElementById('fuelForm');
    const logBody = document.getElementById('logBody');
    const entries = [];

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      data.cost = parseFloat(data.cost);
      data.liters = parseFloat(data.liters);
      data.miles = parseFloat(data.miles);
      
      // Calculate MPG: miles per gallon (UK gallons)
      const gallons = data.liters / 4.546;
      data.mpg = data.miles / gallons;
      
      data.costPerMile = data.cost / data.miles;
      data.costPerLiter = data.cost / data.liters;
      data.notes = data.notes || "";

      db.collection("fuelLogs").add(data).then(docRef => {
        entries.push({ ...data, id: docRef.id });
        form.reset();
        updateUI();
      });
    });

    function updateUI() {
      logBody.innerHTML = '';
      let totalMiles = 0, totalSpend = 0, totalLiters = 0, totalMPG = 0, totalCPM = 0, totalCPL = 0;

      // Sort entries by date (newest first)
      const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));

      sortedEntries.forEach(entry => {
        totalMiles += entry.miles;
        totalSpend += entry.cost;
        totalLiters += entry.liters;
        totalMPG += entry.mpg;
        totalCPM += entry.costPerMile;
        totalCPL += entry.costPerLiter;

        // Format date as dd/mm/yy
        const dateObj = new Date(entry.date);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = String(dateObj.getFullYear()).slice(-2);
        const formattedDate = `${day}/${month}/${year}`;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formattedDate}</td>
          <td>£${entry.cost.toFixed(2)}</td>
          <td>${entry.liters.toFixed(2)}</td>
          <td>${entry.miles}</td>
          <td>${entry.mpg.toFixed(1)}</td>
          <td>£${entry.costPerMile.toFixed(2)}</td>
          <td>£${entry.costPerLiter.toFixed(2)}</td>
          <td>${entry.notes}</td>
          <td><button onclick="deleteEntry('${entry.id}')">Delete</button></td>
        `;
        logBody.appendChild(row);
      });

      const avgMPG = entries.length ? totalMPG / entries.length : 0;
      const avgCPM = entries.length ? totalCPM / entries.length : 0;
      const avgCPL = entries.length ? totalCPL / entries.length : 0;

      document.getElementById('avgMPG').textContent = `Avg MPG: ${avgMPG.toFixed(1)}`;
      document.getElementById('avgCostPerMile').textContent = `Avg £/Mile: £${avgCPM.toFixed(2)}`;
      document.getElementById('avgCostPerLiter').textContent = `Avg £/Liter: £${avgCPL.toFixed(2)}`;
      document.getElementById('totalMiles').textContent = `Total Miles: ${totalMiles}`;
      document.getElementById('totalSpend').textContent = `Total Spend: £${totalSpend.toFixed(2)}`;
      document.getElementById('totalLiters').textContent = `Total Liters: ${totalLiters.toFixed(1)}`;

      renderCharts();
    }

    function renderCharts() {
      const labels = entries.map(e => e.date);
      const mpgData = entries.map(e => e.mpg.toFixed(1));
      const costData = entries.map(e => e.cost.toFixed(2));

      new Chart(document.getElementById('mpgChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'MPG',
            data: mpgData,
            borderColor: '#0078D4',
            fill: false
          }]
        }
      });

      new Chart(document.getElementById('costChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Cost (£)',
            data: costData,
            backgroundColor: '#0078D4'
          }]
        }
      });
    }

    function deleteEntry(id) {
      db.collection("fuelLogs").doc(id).delete().then(() => {
        const index = entries.findIndex(e => e.id === id);
        if (index !== -1) {
          entries.splice(index, 1);
          updateUI();
        }
      });
    }

    db.collection("fuelLogs").orderBy("date").get().then(snapshot => {
      snapshot.forEach(doc => {
        const entry = doc.data();
        entry.id = doc.id;
        entry.cost = parseFloat(entry.cost);
        entry.liters = parseFloat(entry.liters || 0);
        entry.miles = parseFloat(entry.miles);
        
        // Recalculate MPG if liters is available
        if (entry.liters > 0) {
          const gallons = entry.liters / 4.546;
          entry.mpg = entry.miles / gallons;
        } else {
          // Fallback for old entries without liters
          entry.mpg = entry.mpg || 0;
        }
        
        entry.costPerMile = entry.cost / entry.miles;
        entry.costPerLiter = entry.liters > 0 ? entry.cost / entry.liters : 0;
        entries.push(entry);
      });
      updateUI();
    });
  </script>
</body>
</html>
